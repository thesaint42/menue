name: Deploy via SSH

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Prepare deploy environment
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_BRANCH: ${{ secrets.DEPLOY_BRANCH }}
          DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
        run: |
          # If a private key was provided, configure ssh-agent for subsequent SSH commands
          if [ -n "${{ secrets.DEPLOY_KEY }}" ]; then
            echo "Setting up ssh-agent with provided DEPLOY_KEY"
            mkdir -p ~/.ssh
            echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key
            eval "$(ssh-agent -s)"
            ssh-add ~/.ssh/deploy_key
          else
            echo "No DEPLOY_KEY provided; will use password-based ssh (sshpass)"
            sudo apt-get update -y
            sudo apt-get install -y sshpass || true
          fi

      - name: Execute deploy commands
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_BRANCH: ${{ secrets.DEPLOY_BRANCH }}
          DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
        run: |
          BRANCH="${DEPLOY_BRANCH:-main}"
          # Choose SSH invocation depending on whether we have an agent with keys or must use sshpass
          if ssh-add -l >/dev/null 2>&1; then
            echo "Deploying using SSH key to ${DEPLOY_HOST}"
            ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} "
              set -e
              if [ ! -d '${DEPLOY_PATH}/.git' ]; then
                echo 'Target path is not a git repo. Attempting to clone...'
                git clone --depth 1 --branch ${BRANCH} https://github.com/${{ github.repository }} ${DEPLOY_PATH}
              fi
              cd ${DEPLOY_PATH}
              git fetch --all --prune
              git reset --hard origin/${BRANCH}
              php -r 'if(function_exists("opcache_reset")){opcache_reset(); echo "opcache reset\n"; }' || true
              if command -v systemctl >/dev/null 2>&1; then sudo systemctl restart php8.1-fpm || true; fi
            "
          else
            echo "Deploying using password to ${DEPLOY_HOST}"
            sshpass -p "${DEPLOY_PASSWORD}" ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} "
              set -e
              if [ ! -d '${DEPLOY_PATH}/.git' ]; then
                echo 'Target path is not a git repo. Attempting to clone...'
                git clone --depth 1 --branch ${BRANCH} https://github.com/${{ github.repository }} ${DEPLOY_PATH}
              fi
              cd ${DEPLOY_PATH}
              git fetch --all --prune
              git reset --hard origin/${BRANCH}
              php -r 'if(function_exists("opcache_reset")){opcache_reset(); echo "opcache reset\n"; }' || true
              if command -v systemctl >/dev/null 2>&1; then sudo systemctl restart php8.1-fpm || true; fi
            "
          fi
