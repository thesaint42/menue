name: Deploy via FTP/SFTP

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show files to upload
        run: |
          echo "Files in repo (top):"
          ls -la | sed -n '1,200p'

      - name: Install lftp
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp

      - name: Deploy via lftp (upload only changed files)
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_PASSWORD: ${{ secrets.DEPLOY_PASSWORD }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DEPLOY_PROTOCOL: ${{ secrets.DEPLOY_PROTOCOL }}
        run: |
          set -ex
          PROTO="${DEPLOY_PROTOCOL:-sftp}"
          URL="${PROTO}://${DEPLOY_USER}:${DEPLOY_PASSWORD}@${DEPLOY_HOST}"
          REMOTE_ROOT="${DEPLOY_PATH:-.}"
          echo "Deploying to $URL path ${REMOTE_ROOT}"

          # Determine changed files between commits. For push events use event.before/event.after; for manual runs fall back
          if [ -n "${{ github.event.before || '' }}" ] && [ -n "${{ github.sha || '' }}" ]; then
            echo "Detected push event; computing changed files"
            CHANGED_FILES=$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" || true)
          else
            echo "Fallback: using last commit diff"
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || true)
          fi

          echo "Changed files list:"; echo "$CHANGED_FILES"

          # If no changed files found, fall back to mirror with --only-newer but DO NOT --delete (less disruptive)
          if [ -z "$CHANGED_FILES" ]; then
            echo "No changed-files list found; using conservative mirror (only newer, no delete)"
            lftp -c "set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate no; set ftp:passive-mode true; set net:timeout 60; set net:max-retries 1; set net:reconnect-interval-base 5; set mirror:parallel-transfer-count 1; set net:connection-limit 1; open -p 21 -u \"${DEPLOY_USER}\",\"${DEPLOY_PASSWORD}\" \"${DEPLOY_HOST}\"; mirror -R --verbose --only-newer --no-symlinks --parallel=1 ./ ${REMOTE_ROOT}; bye"
            exit 0
          fi

          # Upload only added/modified files. Do NOT perform deletions on the remote by default.
          cmds=""
          for file in $CHANGED_FILES; do
            [ -z "$file" ] && continue
            # skip workflow files and local-only dirs
            case "$file" in
              .github/*|.git/*|tools/*) echo "Skipping $file"; continue ;;
              script/config.yaml|install.php) echo "Protected file, skipping $file"; continue ;;
            esac
            # Protect storage directory
            if [[ "$file" == storage/* ]] || [ "$file" = "storage" ]; then
              echo "Skipping protected dir: $file"; continue
            fi

            if [ -f "$file" ]; then
              remote_dir=$(dirname "$REMOTE_ROOT/$file")
              echo "Queueing upload: $file -> $remote_dir"
              cmds="$cmds; mkdir -p \"$remote_dir\"; put -O \"$remote_dir\" \"$file\""
            elif [ -d "$file" ]; then
              echo "Queueing mirror for directory: $file"
              # mirror command needs proper remote path
              remote_dest="${REMOTE_ROOT%/}/$file"
              cmds="$cmds; mirror -R --verbose --only-newer --no-symlinks --parallel=1 \"$file\" \"$remote_dest\""
            else
              echo "Skipping (deleted or unknown type): $file"
            fi
          done

          cmds="${cmds#; }"

          LFTP_CMDS="set ftp:ssl-force true; set ftp:ssl-protect-data true; set ssl:verify-certificate no; set ftp:passive-mode true; set net:timeout 60; set net:max-retries 2; set net:reconnect-interval-base 5; set mirror:parallel-transfer-count 1; set net:connection-limit 1; open -p 21 -u \"${DEPLOY_USER}\",\"${DEPLOY_PASSWORD}\" \"${DEPLOY_HOST}\"; $cmds; bye"

          echo "Running lftp once with queued commands"
          lftp -c "$LFTP_CMDS"

          echo "Upload finished."
